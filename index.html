import { useState } from "react";
import { Button } from "@/components/ui/button";
import { Card, CardContent } from "@/components/ui/card";
import { jsPDF } from "jspdf";

export default function UniqueUrenCalculator() {
  const [weeks, setWeeks] = useState([{ id: 1, days: generateWeek() }]);

  function generateWeek(startMonday = new Date()) {
    let monday = new Date(startMonday);
    monday.setDate(monday.getDate() - monday.getDay() + 1);
    return Array.from({ length: 7 }, (_, i) => {
      let day = new Date(monday);
      day.setDate(monday.getDate() + i);
      return { date: day.toLocaleDateString("nl-NL"), start: "", end: "", break: false, total: "0:00" };
    });
  }

  function calculateHours(day) {
    if (!day.start || !day.end) return "0:00";
    let start = new Date(`1970-01-01T${day.start}:00`);
    let end = new Date(`1970-01-01T${day.end}:00`);
    let diff = (end - start) / (1000 * 60);
    if (day.break) diff -= 30;
    let hours = Math.floor(diff / 60);
    let minutes = diff % 60;
    return `${hours}:${minutes < 10 ? "0" : ""}${minutes}`;
  }

  function updateDay(weekIndex, dayIndex, field, value) {
    let newWeeks = [...weeks];
    let day = newWeeks[weekIndex].days[dayIndex];
    day[field] = value;
    day.total = calculateHours(day);
    setWeeks(newWeeks);
  }

  function addWeek() {
    setWeeks([...weeks, { id: weeks.length + 1, days: generateWeek() }]);
  }

  function removeWeek(index) {
    if (weeks.length > 1) {
      setWeeks(weeks.filter((_, i) => i !== index));
    }
  }

  function exportToPDF() {
    const doc = new jsPDF();
    weeks.forEach((week, index) => {
      doc.text(`Week ${index + 1}`, 10, 10 + index * 20);
      week.days.forEach((day, i) => {
        doc.text(`${day.date}: ${day.start} - ${day.end} (${day.break ? "met pauze" : "geen pauze"})`, 10, 20 + i * 10 + index * 20);
      });
    });
    doc.save("urenregistratie.pdf");
  }

  return (
    <div className="p-4">
      {weeks.map((week, wIndex) => (
        <Card key={week.id} className="mb-4">
          <CardContent>
            <h2 className="text-lg font-bold">Week {wIndex + 1}</h2>
            {week.days.map((day, dIndex) => (
              <div key={dIndex} className="flex gap-2 items-center mt-2">
                <span className="w-24">{day.date}</span>
                <input type="time" value={day.start} onChange={(e) => updateDay(wIndex, dIndex, "start", e.target.value)} className="border p-1" />
                <input type="time" value={day.end} onChange={(e) => updateDay(wIndex, dIndex, "end", e.target.value)} className="border p-1" />
                <input type="checkbox" checked={day.break} onChange={(e) => updateDay(wIndex, dIndex, "break", e.target.checked)} />
                <span>{day.total} uur</span>
              </div>
            ))}
            <Button onClick={() => removeWeek(wIndex)} disabled={weeks.length === 1} className="mt-2">Verwijder</Button>
          </CardContent>
        </Card>
      ))}
      <Button onClick={addWeek} className="mr-2">+ Voeg Week Toe</Button>
      <Button onClick={exportToPDF}>Exporteer als PDF</Button>
    </div>
  );
}
